<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üéØ Interface de Saisie - Tir Sportif</title>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <!-- QRCode.js pour g√©n√©rer les QR Codes -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <style>
    * { margin:0; padding:0; box-sizing:border-box; }

    body{
      font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding:20px; min-height:100vh;
    }

    .container{ max-width:1200px; margin:0 auto; }

    .header{
      background:white; padding:30px; border-radius:15px; margin-bottom:20px;
      box-shadow:0 10px 30px rgba(0,0,0,0.2); text-align:center;
    }

    .header h1{ color:#667eea; font-size:2.5em; margin-bottom:10px; }

    .header .competition-name{ font-size:1.3em; color:#555; margin-top:10px; }

    .header .status{
      display:inline-block; padding:8px 20px; border-radius:20px; margin-top:15px; font-weight:bold;
    }
    .status.online{ background:#d4edda; color:#155724; }
    .status.offline{ background:#f8d7da; color:#721c24; }

    .main-content{
      display:grid; grid-template-columns: 1fr 1fr;
      gap:20px; margin-bottom:20px;
    }

    .card{
      background:white; padding:25px; border-radius:15px;
      box-shadow:0 10px 30px rgba(0,0,0,0.2);
    }

    .card h2{
      color:#667eea; margin-bottom:20px; display:flex; align-items:center; gap:10px; font-size:1.5em;
    }

    .form-group{ margin-bottom:15px; }

    .form-group label{
      display:block; margin-bottom:5px; color:#555; font-weight:bold;
    }

    .form-group input, .form-group select{
      width:100%; padding:12px; border:2px solid #ddd; border-radius:8px; font-size:1em; transition:border 0.3s;
    }

    .form-group input:focus, .form-group select:focus{
      outline:none; border-color:#667eea;
    }

    .form-row{
      display:grid; grid-template-columns: 1fr 1fr; gap:15px;
    }

    .btn{
      width:100%; padding:15px; border:none; border-radius:8px; font-size:1.1em; font-weight:bold;
      cursor:pointer; transition:all 0.3s; margin-top:10px;
    }

    .btn-primary{ background:#667eea; color:white; }
    .btn-primary:hover{
      background:#5568d3; transform:translateY(-2px);
      box-shadow:0 5px 15px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary{ background:#28a745; color:white; }
    .btn-secondary:hover{ background:#218838; }

    .btn-danger{
      background:#dc3545; color:white; padding:8px 15px; font-size:0.9em; width:auto; margin:0;
    }
    .btn-danger:hover{ background:#c82333; }

    /* Liste pleine largeur */
    .shooters-list{ max-height:65vh; overflow-y:auto; }

    .shooter-item{
      background:#f8f9fa; padding:15px; margin-bottom:10px; border-radius:8px;
      border-left:4px solid #667eea; display:flex; justify-content:space-between; align-items:center;
    }

    .shooter-info{ flex:1; }
    .shooter-info h3{ color:#333; margin-bottom:5px; }
    .shooter-info p{ color:#666; font-size:0.9em; margin:2px 0; }

    .shooter-score{ text-align:right; margin-right:15px; }
    .shooter-score .score{ font-size:2em; font-weight:bold; color:#667eea; }
    .shooter-score .max-score{ font-size:1.2em; color:#999; }

    .shooter-actions{ display:flex; gap:10px; }

    .category-badge{
      display:inline-block; padding:3px 10px; border-radius:12px;
      font-size:0.8em; font-weight:bold; margin-right:5px;
    }

    /* Couleurs pour les cat√©gories jeunes */
    .category-Poussin-Gar√ßon { background:#ffeaa7; color:#d63031; }
    .category-Poussin-Fille { background:#ffccf9; color:#e84393; }
    .category-Benjamin-Gar√ßon { background:#a29bfe; color:#6c5ce7; }
    .category-Benjamin-Fille { background:#fd79a8; color:#d63031; }
    .category-Minime-Gar√ßon { background:#74b9ff; color:#0984e3; }
    .category-Minime-Fille { background:#fab1a0; color:#e17055; }
    .category-Cadet-Gar√ßon { background:#55efc4; color:#00b894; }
    .category-Cadet-Fille { background:#fdcb6e; color:#e17055; }
    .category-Junior-Gar√ßon { background:#81ecec; color:#00b894; }
    .category-Junior-Fille { background:#ffeaa7; color:#fdcb6e; }

    /* Couleurs pour les cat√©gories adultes */
    .category-Senior { background:#74b9ff; color:#0984e3; }
    .category-Dame { background:#fd79a8; color:#d63031; }
    .category-Senior-2 { background:#a29bfe; color:#6c5ce7; }
    .category-Senior-3 { background:#dfe6e9; color:#2d3436; }
    .category-Dame-2 { background:#fab1a0; color:#e17055; }
    .category-Dame-3 { background:#ffccf9; color:#e84393; }

    .qr-section{
      background:#f8f9fa; padding:20px; border-radius:10px; text-align:center; margin-top:20px;
    }

    #qrcode{
      display:inline-block; padding:15px; background:white; border-radius:10px; margin:15px 0;
    }

    .public-url{
      background:white; padding:10px; border-radius:5px; word-break:break-all; margin-top:10px;
      font-family:monospace; border:2px dashed #667eea;
    }

    @media (max-width:768px){
      .main-content{ grid-template-columns:1fr; }
      .form-row{ grid-template-columns:1fr; }
    }

    .empty-state{ text-align:center; padding:40px; color:#999; }
    .empty-state svg{ width:100px; height:100px; margin-bottom:20px; opacity:0.3; }
  </style>
</head>

<body>
  <div class="container">
    <!-- En-t√™te -->
    <div class="header">
      <h1>üéØ Interface de Saisie</h1>
      <div class="competition-name" id="displayCompetitionName">Configuration requise</div>
      <div class="status offline" id="connectionStatus">‚ö†Ô∏è Non connect√© √† Firebase</div>
    </div>

    <!-- Contenu principal -->
    <div class="main-content">
      <!-- Configuration -->
      <div class="card">
        <h2>‚öôÔ∏è Configuration</h2>

        <div class="form-group">
          <label>Nom de la comp√©tition</label>
          <input type="text" id="competitionName" placeholder="Ex: Championnat R√©gional 2024" />
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Score max (par d√©faut)</label>
            <input type="number" id="maxScore" value="600" min="1" />
          </div>
          <div class="form-group">
            <label>Date</label>
            <input type="date" id="competitionDate" />
          </div>
        </div>

        <button class="btn btn-secondary" onclick="saveConfig()">üíæ Sauvegarder la configuration</button>

        <!-- QR Code -->
        <div class="qr-section">
          <h3 style="color:#667eea; margin-bottom:10px;">üì± Partager l'affichage</h3>
          <p style="color:#666; margin-bottom:15px;">Les spectateurs peuvent scanner ce QR Code pour voir les r√©sultats en temps r√©el</p>
          <div id="qrcode"></div>
          <button class="btn btn-primary" onclick="generateQRCode()">üîÑ G√©n√©rer le QR Code</button>
          <div class="public-url" id="publicUrl" style="display:none;"></div>
        </div>
      </div>

      <!-- Ajout de tireur -->
      <div class="card">
        <h2>‚ûï Ajouter un tireur</h2>

        <div class="form-row">
          <div class="form-group">
            <label>Nom</label>
            <input type="text" id="shooterLastName" placeholder="DUPONT" />
          </div>
          <div class="form-group">
            <label>Pr√©nom</label>
            <input type="text" id="shooterFirstName" placeholder="Jean" />
          </div>
        </div>

        <div class="form-group">
          <label>Club</label>
          <input type="text" id="shooterClub" placeholder="Club de Tir de Paris" />
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Cat√©gorie</label>
            <select id="shooterCategory">
              <option value="">-- S√©lectionner --</option>
              <optgroup label="Jeunes Gar√ßons">
                <option value="Poussin Gar√ßon">Poussin Gar√ßon</option>
                <option value="Benjamin Gar√ßon">Benjamin Gar√ßon</option>
                <option value="Minime Gar√ßon">Minime Gar√ßon</option>
                <option value="Cadet Gar√ßon">Cadet Gar√ßon</option>
                <option value="Junior Gar√ßon">Junior Gar√ßon</option>
              </optgroup>
              <optgroup label="Jeunes Filles">
                <option value="Poussin Fille">Poussin Fille</option>
                <option value="Benjamin Fille">Benjamin Fille</option>
                <option value="Minime Fille">Minime Fille</option>
                <option value="Cadet Fille">Cadet Fille</option>
                <option value="Junior Fille">Junior Fille</option>
              </optgroup>
              <optgroup label="Seniors">
                <option value="Senior">Senior (Homme)</option>
                <option value="Dame">Dame</option>
                <option value="Senior 2">Senior 2</option>
                <option value="Senior 3">Senior 3</option>
                <option value="Dame 2">Dame 2</option>
                <option value="Dame 3">Dame 3</option>
              </optgroup>
            </select>
          </div>

          <div class="form-group">
            <label>Discipline</label>
            <select id="shooterDiscipline">
              <option value="">-- S√©lectionner --</option>

              <optgroup label="10 m√®tres">
                <option value="Pistolet 10 m">Pistolet 10 m</option>
                <option value="Pistolet Standard 10 m">Pistolet Standard 10 m (40 coups)</option>
                <option value="Pistolet 10 m Vitesse">Pistolet 10 m Vitesse (40 coups)</option>
                <option value="Carabine 10 m">Carabine 10 m (dixi√®mes)</option>
              </optgroup>

              <optgroup label="25 m√®tres">
                <option value="Pistolet 25 m">Pistolet 25 m</option>
                <option value="Pistolet Standard">Pistolet Standard</option>
                <option value="Pistolet Vitesse Olympique">Pistolet Vitesse Olympique</option>
                <option value="Pistolet Percussion Centrale">Pistolet Percussion Centrale</option>
                <option value="Sport Pistol">Sport Pistol</option>
              </optgroup>

              <optgroup label="50 m√®tres">
                <option value="Carabine 50 m 3x20">Carabine 50 m 3x20</option>
                <option value="Carabine 50 m Couch√©">Carabine 50 m Couch√©</option>
                <option value="Pistolet Libre 50 m">Pistolet Libre 50 m</option>
              </optgroup>

              <optgroup label="Autres">
                <option value="Arbal√®te Match">Arbal√®te Match</option>
                <option value="Arbal√®te Field">Arbal√®te Field</option>
                <option value="Cible Mobile">Cible Mobile</option>
                <option value="Para Tir">Para Tir</option>
              </optgroup>
            </select>
          </div>
        </div>

        <div class="form-group">
          <label>Score / <span id="maxScoreDisplay">600</span></label>
          <input type="number" id="shooterScore" placeholder="580" min="0" step="1" />
        </div>

        <button class="btn btn-primary" onclick="addShooter()">‚úÖ Ajouter le tireur</button>
      </div>
    </div><!-- fin .main-content -->

    <!-- Liste des tireurs (pleine largeur) -->
    <div class="card">
      <h2>üìä Liste des tireurs</h2>
      <div class="shooters-list" id="shootersList">
        <div class="empty-state">
          <svg viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 2L2 7v10c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V7l-10-5z"/>
          </svg>
          <p>Aucun tireur enregistr√©</p>
          <p style="font-size:0.9em; margin-top:5px;">Ajoutez votre premier tireur ci-dessus</p>
        </div>
      </div>
    </div>
  </div><!-- fin .container -->

  <script>
    // ‚ö†Ô∏è CONFIGURATION FIREBASE - REMPLACEZ PAR VOTRE CONFIGURATION
    const firebaseConfig = {
      apiKey: "AIzaSyAvfMRtRrhh_e-27xHlwIx9c5DIdUQm6HM",
      authDomain: "resultats-tir-ligue-lr.firebaseapp.com",
      databaseURL: "https://resultats-tir-ligue-lr-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "resultats-tir-ligue-lr",
      storageBucket: "resultats-tir-ligue-lr.firebasestorage.app",
      messagingSenderId: "468808300974",
      appId: "1:468808300974:web:563a14cc4477c10b28303f"
    };

    // R√®gles par discipline (max + pas)
    const disciplineRules = {
      "Pistolet 10 m":              { max: 600,  step: 1   },
      "Pistolet Standard 10 m":     { max: 400,  step: 1   }, // 40 plombs -> 400
      "Pistolet 10 m Vitesse":      { max: 400,  step: 1   }, // 40 plombs -> 400
      "Carabine 10 m":              { max: 654.0,step: 0.1 }, // dixi√®mes

      "Pistolet 25 m":              { max: 600,  step: 1   },
      "Pistolet Standard":          { max: 600,  step: 1   },
      "Pistolet Vitesse Olympique": { max: 600,  step: 1   },
      "Pistolet Percussion Centrale":{ max: 600, step: 1   },
      "Sport Pistol":               { max: 600,  step: 1   },

      "Carabine 50 m 3x20":         { max: 600,  step: 1   },
      "Carabine 50 m Couch√©":       { max: 600,  step: 1   },
      "Pistolet Libre 50 m":        { max: 600,  step: 1   },

      "Arbal√®te Match":             { max: 600,  step: 1   },
      "Arbal√®te Field":             { max: 600,  step: 1   },
      "Cible Mobile":               { max: 600,  step: 1   },
      "Para Tir":                   { max: 600,  step: 1   }
    };

    let database;
    let competitionRef;
    let shootersRef;
    let configRef;

    function getEffectiveRule() {
      const discipline = document.getElementById('shooterDiscipline').value;
      const rule = disciplineRules[discipline];
      const fallback = parseFloat(document.getElementById('maxScore').value || 600);
      return {
        discipline,
        max: (rule?.max ?? fallback),
        step: (rule?.step ?? 1)
      };
    }

    function applyDisciplineRules() {
      const { max, step } = getEffectiveRule();

      document.getElementById('maxScoreDisplay').textContent = max;

      const scoreInput = document.getElementById('shooterScore');
      scoreInput.max = max;
      scoreInput.step = step;

      const v = parseFloat(scoreInput.value);
      if (!isNaN(v) && v > max) scoreInput.value = '';
    }

    try {
      firebase.initializeApp(firebaseConfig);
      database = firebase.database();
      competitionRef = database.ref('competition');
      shootersRef = database.ref('ISSF10/shooters');
      configRef = database.ref('ISSF10/config');

      document.getElementById('connectionStatus').className = 'status online';
      document.getElementById('connectionStatus').textContent = '‚úÖ Connect√© √† Firebase';

      loadConfig();

      shootersRef.on('value', (snapshot) => {
        displayShooters(snapshot.val());
      });

    } catch (error) {
      console.error('Erreur Firebase:', error);
      alert('‚ùå Erreur de connexion Firebase. V√©rifiez votre configuration dans le code source.');
    }

    function loadConfig() {
      configRef.once('value', (snapshot) => {
        const config = snapshot.val();
        if (config) {
          document.getElementById('competitionName').value = config.name || '';
          document.getElementById('maxScore').value = config.maxScore || 600;
          document.getElementById('competitionDate').value = config.date || '';
          document.getElementById('displayCompetitionName').textContent = config.name || 'Configuration requise';
        }
        applyDisciplineRules();
      });
    }

    function saveConfig() {
      const name = document.getElementById('competitionName').value.trim();
      const maxScore = parseFloat(document.getElementById('maxScore').value);
      const date = document.getElementById('competitionDate').value;

      if (!name) {
        alert('‚ö†Ô∏è Veuillez entrer un nom pour la comp√©tition');
        return;
      }

      configRef.set({
        name,
        maxScore,
        date,
        lastUpdate: new Date().toISOString()
      }).then(() => {
        document.getElementById('displayCompetitionName').textContent = name;
        applyDisciplineRules();
        alert('‚úÖ Configuration sauvegard√©e !');
      }).catch((error) => {
        alert('‚ùå Erreur: ' + error.message);
      });
    }

    function addShooter() {
      const lastName = document.getElementById('shooterLastName').value.trim().toUpperCase();
      const firstName = document.getElementById('shooterFirstName').value.trim();
      const club = document.getElementById('shooterClub').value.trim();
      const category = document.getElementById('shooterCategory').value;

      const { discipline, max: maxScore, step } = getEffectiveRule();
      const score = parseFloat(document.getElementById('shooterScore').value);

      if (!lastName || !firstName) { alert('‚ö†Ô∏è Veuillez entrer le nom et pr√©nom'); return; }
      if (!category) { alert('‚ö†Ô∏è Veuillez s√©lectionner une cat√©gorie'); return; }
      if (!discipline) { alert('‚ö†Ô∏è Veuillez s√©lectionner une discipline'); return; }
      if (isNaN(score) || score < 0) { alert('‚ö†Ô∏è Veuillez entrer un score valide'); return; }
      if (score > maxScore) { alert(`‚ö†Ô∏è Le score ne peut pas d√©passer ${maxScore}`); return; }

      const normalizedScore = (step === 0.1) ? Number(score.toFixed(1)) : Math.round(score);

      const newShooterRef = shootersRef.push();
      newShooterRef.set({
        lastName,
        firstName,
        club,
        category,
        discipline,
        score: normalizedScore,
        maxScore,
        timestamp: new Date().toISOString()
      }).then(() => {
        document.getElementById('shooterLastName').value = '';
        document.getElementById('shooterFirstName').value = '';
        document.getElementById('shooterClub').value = '';
        document.getElementById('shooterCategory').value = '';
        document.getElementById('shooterDiscipline').value = '';
        document.getElementById('shooterScore').value = '';
        document.getElementById('maxScoreDisplay').textContent = parseFloat(document.getElementById('maxScore').value || 600);
        document.getElementById('shooterLastName').focus();
      }).catch((error) => {
        alert('‚ùå Erreur: ' + error.message);
      });
    }

    function displayShooters(shootersData) {
      const listContainer = document.getElementById('shootersList');

      if (!shootersData) {
        listContainer.innerHTML = `
          <div class="empty-state">
            <svg viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 2L2 7v10c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V7l-10-5z"/>
            </svg>
            <p>Aucun tireur enregistr√©</p>
            <p style="font-size:0.9em; margin-top:5px;">Ajoutez votre premier tireur ci-dessus</p>
          </div>
        `;
        return;
      }

      const shootersArray = Object.entries(shootersData)
        .map(([id, data]) => ({ id, ...data }))
        .sort((a, b) => (b.score ?? 0) - (a.score ?? 0));

      let html = '';
      shootersArray.forEach((shooter, index) => {
        const categoryClass = 'category-' + (shooter.category || '').replace(/ /g, '-');

        const needDecimal =
          String(shooter.maxScore).includes('.') || String(shooter.score).includes('.');

        const displayScore = needDecimal ? Number(shooter.score).toFixed(1) : shooter.score;
        const displayMax = needDecimal ? Number(shooter.maxScore).toFixed(1) : shooter.maxScore;

        html += `
          <div class="shooter-item">
            <div class="shooter-info">
              <h3>${index + 1}. ${shooter.firstName || ''} ${shooter.lastName || ''}</h3>
              <p>
                <span class="${categoryClass} category-badge">${shooter.category || ''}</span>
                <span class="category-badge" style="background:#e0e7ff;color:#3730a3;">${shooter.discipline || ''}</span><br>
                ${shooter.club || ''}
              </p>
            </div>
            <div class="shooter-score">
              <div class="score">${displayScore}</div>
              <div class="max-score">/ ${displayMax}</div>
            </div>
            <div class="shooter-actions">
              <button class="btn btn-danger" onclick="deleteShooter('${shooter.id}')">üóëÔ∏è</button>
            </div>
          </div>
        `;
      });

      listContainer.innerHTML = html;
    }

    function deleteShooter(shooterId) {
      if (confirm('‚ö†Ô∏è √ätes-vous s√ªr de vouloir supprimer ce tireur ?')) {
        shootersRef.child(shooterId).remove();
      }
    }

    function generateQRCode() {
      const qrcodeContainer = document.getElementById('qrcode');
      const publicUrlDiv = document.getElementById('publicUrl');

      qrcodeContainer.innerHTML = '';

      const currentUrl = window.location.href;
      const baseUrl = currentUrl.substring(0, currentUrl.lastIndexOf('/'));
      const publicUrl = baseUrl + '/affichage_ISSF10.html';

      new QRCode(qrcodeContainer, {
        text: publicUrl,
        width: 256,
        height: 256,
        colorDark: "#667eea",
        colorLight: "#ffffff",
        correctLevel: QRCode.CorrectLevel.H
      });

      publicUrlDiv.style.display = 'block';
      publicUrlDiv.innerHTML = `<strong>URL :</strong> <a href="${publicUrl}" target="_blank">${publicUrl}</a>`;

      alert('‚úÖ QR Code g√©n√©r√© ! Les spectateurs peuvent le scanner pour voir l\'affichage.');
    }

    document.getElementById('competitionDate').valueAsDate = new Date();
    document.getElementById('shooterDiscipline').addEventListener('change', applyDisciplineRules);
    document.getElementById('maxScore').addEventListener('change', applyDisciplineRules);

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && e.target.id === 'shooterScore') addShooter();
    });

    applyDisciplineRules();
  </script>
</body>
</html>
